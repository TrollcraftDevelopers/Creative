package pl.trollcraft.creative.chat.commands;

import org.bukkit.Bukkit;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import pl.trollcraft.creative.chat.ChatProcessor;
import pl.trollcraft.creative.chat.ChatProfile;
import pl.trollcraft.creative.core.commands.CommandController;
import pl.trollcraft.creative.core.help.Colors;

import java.util.List;
import java.util.stream.Collectors;

public class ChatCommand extends CommandController {

    @Override
    public void command(CommandSender sender, String label, String[] args) {

        if (!sender.hasPermission("creative.admin") && !sender.hasPermission("creative.vip")){
            sender.sendMessage(Colors.color("&cBrak uprawnien."));
            return;
        }

        if (args.length == 0){
            sender.sendMessage(Colors.color("&7Zarzadzanie chat'em"));
            sender.sendMessage("");
            sender.sendMessage(Colors.color("&e/chat toggle - &7wylacza Twoj chat,"));

            if (sender.hasPermission("creative.admin"))
                sender.sendMessage(Colors.color("&e/chat gtoggle - &7wylacza chat globalnie."));

            return;
        }

        if (args[0].equalsIgnoreCase("gtoggle")) {

            if (!sender.hasPermission("creative.admin")){
                sender.sendMessage(Colors.color("&cBrak uprawnien."));
                return;
            }

            ChatProcessor.switchChat();

            String message = Colors.color("&7Administrator &awlaczyl chat.");
            if (!ChatProcessor.isChatEnabled())
                message = Colors.color("&7Administrator &cwylaczyl chat.");

            final String msg = message;
            Bukkit.getOnlinePlayers().forEach( player -> player.sendMessage(msg) );
            return;
        }

        if (args[0].equalsIgnoreCase("toggle")) {

            if (!(sender instanceof Player)){
                sender.sendMessage("Komenda jedynie dla graczy online.");
                return;
            }

            if (!sender.hasPermission("creative.vip")){
                sender.sendMessage(Colors.color("&cKomenda ta dostepna jest dla graczy &eVIP i SVIP."));
                return;
            }

            Player player = (Player) sender;
            ChatProfile profile = ChatProfile.get(player);

            boolean chat = !profile.hasChatEnabled();
            profile.setChatEnabled(chat);

            if (chat)
                player.sendMessage(Colors.color("&aWlaczono chat."));
            else
                player.sendMessage(Colors.color("&aWylaczono chat."));

            return;
        }

        if (args[0].equalsIgnoreCase("clear")) {

            if (!sender.hasPermission("creative.chat.clear")) {
                sender.sendMessage(Colors.color("&cBrak uprawnien."));
                return;
            }

            List<Player> players = Bukkit.getOnlinePlayers().stream()
                    .filter( p -> !p.hasPermission("creative.chat.admin"))
                    .collect(Collectors.toList());

            for (int i = 0 ; i < 30 ; i++)
                players.forEach( p -> p.sendMessage("") );

            players.forEach(p -> p.sendMessage(Colors.color("&aChat zostal &ewyczyszczony.\n\n")));

        }

    }
}
